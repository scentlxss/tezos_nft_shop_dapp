{"version":3,"file":"taquito-tzip12.es5.js","sources":["../src/tzip12-errors.ts","../src/tzip12-contract-abstraction.ts","../src/composer.ts","../src/tzip12-extension.ts","../src/version.ts"],"sourcesContent":["export class TokenMetadataNotFound implements Error {\n    name: string = 'TokenMetadataNotFound';\n    message: string;\n\n    constructor(public address: string) {\n        this.message = `No token metadata was found for the contract: ${address}`;\n    }\n}\n\nexport class TokenIdNotFound implements Error {\n    name: string = 'TokenIdNotFound';\n    message: string;\n\n    constructor(public tokenId: number) {\n        this.message = `Could not find token metadata for the token ID: ${tokenId}`;\n    }\n}\n\nexport class InvalidTokenMetadata implements Error {\n    name = 'InvalidTokenMetadata';\n    message = 'Non-compliance with the TZIP-012 standard. The required property `decimals` is missing.';\n}","import { MichelsonMap, Schema } from '@taquito/michelson-encoder';\nimport { ContractAbstraction, ContractProvider, Wallet } from '@taquito/taquito';\nimport { Tzip16ContractAbstraction, MetadataContext, View, bytes2Char, MetadataInterface } from '@taquito/tzip16'\nimport { InvalidTokenMetadata, TokenIdNotFound, TokenMetadataNotFound } from './tzip12-errors';\n\nconst tokenMetadataBigMapType = {\n    prim: 'big_map',\n    args: [\n        { prim: 'nat' }, \n        { prim: 'pair', args: [\n            { prim: 'nat' , annots: ['%token_id']}, \n            { prim: \"map\", args: [{ prim: 'string' }, { prim: 'bytes' }], annots: ['%token_info'] }] }],\n    annots: ['%token_metadata']\n};\n\ntype BigMapId = { int: string };\n\nexport interface TokenMetadata {\n    token_id: number,\n    decimals: number\n    name?: string,\n    symbol?: string,\n}\n\nexport class Tzip12ContractAbstraction {\n    private _tzip16ContractAbstraction: Tzip16ContractAbstraction;\n\n    constructor(\n        private contractAbstraction: ContractAbstraction<ContractProvider | Wallet>,\n        private context: MetadataContext\n    ) {\n        this._tzip16ContractAbstraction = new Tzip16ContractAbstraction(this.contractAbstraction, this.context)\n    }\n\n    /**\n     * @description Fetches the contract metadata (according to the Tzip-016 standard)\n     * @returns An object containing the metadata, the uri, an optional integrity check result and an optional sha256 hash \n     * or `Undefined` if the contract has no metadata (non-compliant with Tzip-016)\n     */\n    private async getContractMetadata() {\n        try {\n            const contractMetadata = await this._tzip16ContractAbstraction.getMetadata();\n            return contractMetadata.metadata;\n        } catch (err) {\n            // The contract is not compliant with Tzip-016. There is no contract metadata.\n        }\n    }\n\n    /**\n     * @description The Tzip-016 \"interfaces\" field MUST be present in the contract metadata. It should contain \"TZIP-012[version-info]\"\n     * @returns True if \"interfaces\" field is present and contains \"TZIP-012\", false otherwise\n     */\n    async isTzip12Compliant() {\n        let isCompliant = false;\n        const metadata = await this.getContractMetadata();\n        if (metadata) {\n            const tzip12Interface = metadata.interfaces?.filter((x) => {\n                return x.substring(0, 8) === \"TZIP-012\";\n            });\n            isCompliant = (tzip12Interface && tzip12Interface.length !== 0) ? true : false;\n        }\n        return isCompliant;\n    }\n\n    /**\n     * @description Fetches the token metadata for a specified token ID.\n     * The function first tries to find a `token_metadata` view in the contract metadata and to execute it with the token ID.\n     * If there is no view, the function tries to find a `token_metadata` bigmap in the top-level pairs of the storage.\n     * @param tokenId The ID of the token for which we want to retrieve token metadata\n     * @returns An object of type `TokenMetadata`\n     */\n    async getTokenMetadata(tokenId: number) {\n        const tokenMetadata = await this.retrieveTokenMetadataFromView(tokenId);\n        return (!tokenMetadata) ? this.retrieveTokenMetadataFromBigMap(tokenId) : tokenMetadata;\n    }\n\n    private async retrieveTokenMetadataFromView(tokenId: number) {\n        if (await this.getContractMetadata()) {\n            const views = await this._tzip16ContractAbstraction.metadataViews();\n            if (views && this.hasTokenMetadataView(views)) {\n                return this.executeTokenMetadataView(views['token_metadata'](), tokenId);\n            }\n        }\n    }\n\n    private hasTokenMetadataView(views: {}) {\n        for (let view of Object.keys(views)) {\n            if (view === 'token_metadata') {\n                return true;\n            }\n        }\n        return false;\n    }\n\n    private async executeTokenMetadataView(tokenMetadataView: View, tokenId: number): Promise<TokenMetadata> {\n        let tokenMetadata;\n        try {\n            tokenMetadata = await tokenMetadataView.executeView(tokenId);\n        } catch (err) {\n            throw new TokenIdNotFound(tokenId);\n        }\n        const tokenMap = Object.values(tokenMetadata)[1];\n        if (!MichelsonMap.isMichelsonMap(tokenMap)) {\n            throw new TokenMetadataNotFound(this.contractAbstraction.address);\n        }\n        const metadataFromUri = await this.fetchTokenMetadataFromUri(tokenMap as MichelsonMap<string, string>);\n        return this.formatMetadataToken(tokenId, (tokenMap as MichelsonMap<string, string>), metadataFromUri);\n    }\n\n    private async fetchTokenMetadataFromUri(tokenMetadata: MichelsonMap<string, string>) {\n        const uri = tokenMetadata.get(\"\");\n        if (uri) {\n            try {\n                const metadataFromUri = await this.context.metadataProvider.provideMetadata(\n                    this.contractAbstraction,\n                    bytes2Char(uri),\n                    this.context\n                );\n                return metadataFromUri.metadata;\n            } catch (e) {\n                if (e.name === 'InvalidUri') {\n                    console.warn(`The URI ${bytes2Char(uri)} is present in the token metadata, but is invalid.`);\n                } else {\n                    throw e;\n                }\n            }\n        }\n    }\n\n    private formatMetadataToken(tokenId: number, metadataTokenMap: MichelsonMap<string, string>, metadataFromUri?: any): TokenMetadata {\n        const tokenMetadataDecoded = {\n            'token_id': tokenId\n        };\n        for (let keyTokenMetadata of metadataTokenMap.keys()) {\n            if (keyTokenMetadata === 'decimals') {\n                Object.assign(tokenMetadataDecoded, { [keyTokenMetadata]: Number(bytes2Char(metadataTokenMap.get(keyTokenMetadata)!)) });\n            }\n            else if (!(keyTokenMetadata === '')) {\n                Object.assign(tokenMetadataDecoded, { [keyTokenMetadata]: bytes2Char(metadataTokenMap.get(keyTokenMetadata)!) });\n            }\n        }\n        // if an URI is present, add the fetched properties to the object\n        // if a property is in the URI and the map, prevalence is accorded to value from the URI\n        if (metadataFromUri) {\n            for(let property in metadataFromUri) {\n                Object.assign(tokenMetadataDecoded, {[property]: metadataFromUri[property]})\n            }\n        }\n        if(!('decimals' in tokenMetadataDecoded)) {\n            throw new InvalidTokenMetadata();\n        } \n        return tokenMetadataDecoded;\n    }\n\n    private async retrieveTokenMetadataFromBigMap(tokenId: number) {\n        const bigmapTokenMetadataId = this.findTokenMetadataBigMap();\n        let pairNatMap;\n        try {\n            pairNatMap = await this.context.contract.getBigMapKeyByID<any>(\n                bigmapTokenMetadataId['int'].toString(),\n                tokenId.toString(),\n                new Schema(tokenMetadataBigMapType)\n            );\n        } catch (err) {\n            throw new TokenIdNotFound(tokenId);\n        }\n\n        const michelsonMap = pairNatMap['token_info'];\n        if (!MichelsonMap.isMichelsonMap(michelsonMap)) {\n            throw new TokenIdNotFound(tokenId);\n        }\n        const metadataFromUri = await this.fetchTokenMetadataFromUri(michelsonMap as MichelsonMap<string, string>);\n        return this.formatMetadataToken(tokenId, michelsonMap as MichelsonMap<string, string>, metadataFromUri)\n    }\n\n    private findTokenMetadataBigMap(): BigMapId {\n        const tokenMetadataBigMapId = this.contractAbstraction.schema.FindFirstInTopLevelPair<BigMapId>(\n            this.contractAbstraction.script.storage,\n            tokenMetadataBigMapType\n        );\n        if (!tokenMetadataBigMapId) {\n            throw new TokenMetadataNotFound(this.contractAbstraction.address);\n        }\n        return tokenMetadataBigMapId;\n    }\n\n\n}\n","import { Context, ContractAbstraction, ContractProvider, Wallet } from \"@taquito/taquito\";\nimport { Tzip12ContractAbstraction } from './tzip12-contract-abstraction'\nimport { MetadataContext } from \"@taquito/tzip16\"\n\nconst ABSTRACTION_KEY = Symbol(\"Tzip12ContractAbstractionObjectKey\");\n\nexport function tzip12<T extends ContractAbstraction<ContractProvider | Wallet>>(abs: T, context: Context) {\n    return Object.assign(abs, {\n        // namespace tzip12\n        tzip12 (this: ContractAbstraction<ContractProvider | Wallet> & { [ABSTRACTION_KEY]?: Tzip12ContractAbstraction}) {\n            if (!this[ABSTRACTION_KEY]) {\n                this[ABSTRACTION_KEY] = new Tzip12ContractAbstraction(this, context as MetadataContext);\n            }\n            \n            return this[ABSTRACTION_KEY]!\n        }\n    })\n}","import { Context, Extension } from \"@taquito/taquito\";\nimport { DEFAULT_HANDLERS, MetadataProviderInterface, MetadataProvider } from '@taquito/tzip16'\n\n// The same default metadataProvider is used for tzip16 and tzip12\nexport class Tzip12Module implements Extension {\n    private _metadataProvider: MetadataProviderInterface;\n\n    constructor(metadataProvider?: MetadataProviderInterface) {\n        this._metadataProvider = metadataProvider ? metadataProvider : new MetadataProvider(DEFAULT_HANDLERS);\n    }\n\n    configureContext(context: Context) {\n        Object.assign(context, { metadataProvider: this._metadataProvider });\n    }\n}","\n// IMPORTANT: THIS FILE IS AUTO GENERATED! DO NOT MANUALLY EDIT OR CHECKIN!\n/* tslint:disable */\nexport const VERSION = {\n    \"commitHash\": \"33283ebb64d801dcbb0926ad199d024ad7189861\",\n    \"version\": \"10.1.0\"\n};\n/* tslint:enable */\n"],"names":[],"mappings":"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"}